name: Docker Image Security Scan

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Build Docker image
      - name: Build Docker image
        run: docker build -t myapp:latest .

      # 3. Run Trivy vulnerability scan
      - name: Trivy scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: 'myapp:latest'
          format: 'table'
          exit-code: '0'
          ignore-unfixed: false
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH,MEDIUM'
          output: 'scan-report.txt'

      # 4. Create a simple mitigation summary
      - name: Generate mitigation summary
        run: |
          echo "ðŸ“Œ Vulnerability Mitigation Summary" > mitigation-summary.txt
          echo "" >> mitigation-summary.txt
          echo "1. Update your Docker base image to the latest stable version." >> mitigation-summary.txt
          echo "2. Update OS packages inside the image (apk/apt/yum)." >> mitigation-summary.txt
          echo "3. Update application dependencies to secure versions." >> mitigation-summary.txt
          echo "4. Remove unnecessary tools or packages from the image." >> mitigation-summary.txt
          echo "5. Rebuild and re-scan the image to verify fixes." >> mitigation-summary.txt

      # 5. Upload scan report
      - name: Upload scan report
        uses: actions/upload-artifact@v4
        with:
          name: scan-report
          path: scan-report.txt

      # 6. Upload mitigation summary
      - name: Upload mitigation summary
        uses: actions/upload-artifact@v4
        with:
          name: mitigation-summary
          path: mitigation-summary.txt
